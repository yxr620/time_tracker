# AI æ—¶é—´åŠ©æ‰‹ - æŠ€æœ¯æ–‡æ¡£

> æœ¬æ–‡æ¡£é¢å‘å¼€å‘è€…ï¼Œè¯¦ç»†è¯´æ˜ AI æ—¶é—´åŠ©æ‰‹åŠŸèƒ½çš„æŠ€æœ¯æ¶æ„ã€æ¨¡å—è®¾è®¡ä¸æ•°æ®æµã€‚
> ç”¨æˆ·ä½¿ç”¨æŒ‡å—è¯·æŸ¥çœ‹ [manual.md](./manual.md)ã€‚

---

## 1. æ¶æ„æ¦‚è¿°

AI æ—¶é—´åŠ©æ‰‹é‡‡ç”¨ **Function Callingï¼ˆå·¥å…·è°ƒç”¨ï¼‰** æ¶æ„ï¼Œè®© LLM è‡ªä¸»å†³å®šæŸ¥è¯¢å“ªäº›æ•°æ®ã€‚æ ¸å¿ƒè®¾è®¡ï¼š

- **å‰ç«¯æœ¬åœ°æ•°æ®**ï¼šæ‰€æœ‰æ—¶é—´è®°å½•å­˜å‚¨åœ¨æµè§ˆå™¨ IndexedDBï¼ˆDexie.jsï¼‰ï¼ŒLLM æ— æ³•ç›´æ¥è®¿é—®
- **å·¥å…·è°ƒç”¨æ¡¥æ¥**ï¼šå°†æ•°æ®æŸ¥è¯¢èƒ½åŠ›å°è£…ä¸º LLM å¯è°ƒç”¨çš„å·¥å…·å‡½æ•°ï¼Œåœ¨æµè§ˆå™¨æœ¬åœ°æ‰§è¡Œ
- **å¤šè½®å¾ªç¯**ï¼šLLM å¯å¤šæ¬¡è°ƒç”¨å·¥å…·ï¼Œè·å–å¤šä¸ªæ—¶é—´æ®µã€å¤šç§ç­›é€‰ç»´åº¦çš„æ•°æ®åç»¼åˆå›ç­”

```
ç”¨æˆ·æé—®
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  buildSystemPrompt()             â”‚
â”‚  è§’è‰² + å½“å‰æ—¥æœŸ + ç±»åˆ«åˆ—è¡¨       â”‚
â”‚  + å·¥å…·ä½¿ç”¨æŒ‡å— + å›ç­”è§„åˆ™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è¯·æ±‚ï¼ˆéæµå¼ + toolsï¼‰       â”‚
â”‚  LLM åˆ†æç”¨æˆ·æ„å›¾ï¼Œå†³å®šè°ƒç”¨å·¥å…·    â”‚
â”‚  â†“                               â”‚
â”‚  è¿”å› tool_calls:                â”‚
â”‚  [query_time_entries(1æœˆ, å­¦ä¹ ),  â”‚
â”‚   query_time_entries(2æœˆ, å­¦ä¹ )]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°æ‰§è¡Œå·¥å…·ï¼ˆIndexedDB æŸ¥è¯¢ï¼‰   â”‚
â”‚  å·¥å…·ç»“æœ â†’ role: 'tool' å›å¡«     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼  â† å¯å¾ªç¯æœ€å¤š 5 è½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æœ€ç»ˆå›ç­”ï¼ˆæµå¼è¾“å‡ºï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ¨¡å—ç»“æ„

```
src/services/ai/
â”œâ”€â”€ toolCallEngine.ts    # å·¥å…·è°ƒç”¨å¾ªç¯å¼•æ“ï¼ˆæ ¸å¿ƒç¼–æ’ï¼‰
â”œâ”€â”€ toolDefinitions.ts   # å·¥å…· schema å®šä¹‰ + æœ¬åœ°æ‰§è¡Œå‡½æ•°
â”œâ”€â”€ llmClient.ts         # LLM ç½‘ç»œå±‚ï¼ˆæµå¼/éæµå¼/å·¥å…·è°ƒç”¨ï¼‰
â”œâ”€â”€ providers.ts         # æœåŠ¡å•†é¢„è®¾é…ç½®
â”œâ”€â”€ contextBuilder.ts    # [é—ç•™] æ—§ç‰ˆä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼ˆå·²å¼ƒç”¨ï¼‰
â””â”€â”€ intentParser.ts      # [é—ç•™] æ—§ç‰ˆæ­£åˆ™æ—¶é—´è§£æï¼ˆå·²å¼ƒç”¨ï¼‰

src/components/AIAssistant/
â”œâ”€â”€ AIAssistant.tsx      # å¯¹è¯ç•Œé¢ä¸»ç»„ä»¶
â”œâ”€â”€ AIAssistant.css      # æ ·å¼
â””â”€â”€ AISettings.tsx       # æœåŠ¡å•†é…ç½®å¼¹çª—

src/stores/
â””â”€â”€ aiStore.ts           # AI é…ç½® + å¯¹è¯çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
```

---

## 3. å·¥å…·å®šä¹‰ (`toolDefinitions.ts`)

### 3.1 å·¥å…·åˆ—è¡¨

| å·¥å…·å | å‚æ•° | åŠŸèƒ½ |
|--------|------|------|
| `query_time_entries` | `start_date`, `end_date`, `category?`, `goal?` | æŸ¥è¯¢æ—¶é—´è®°å½•ï¼Œè¿”å›ç»Ÿè®¡æ‘˜è¦ + è¯¦ç»†è®°å½•ï¼ˆæœ€å¤š 200 æ¡ï¼‰ |
| `list_categories` | æ—  | è·å–æ‰€æœ‰æ´»åŠ¨ç±»åˆ«åç§° |
| `list_goals` | `start_date`, `end_date` | è·å–æŒ‡å®šæ—¥æœŸèŒƒå›´çš„ç›®æ ‡åˆ—è¡¨ |

### 3.2 å·¥å…· Schemaï¼ˆOpenAI Function Calling æ ¼å¼ï¼‰

æ¯ä¸ªå·¥å…·æŒ‰ OpenAI `tools` æ ‡å‡†æ ¼å¼å£°æ˜ï¼ŒåŒ…å« `type: 'function'`ã€`function.name`ã€`function.description`ã€`function.parameters`ï¼ˆJSON Schemaï¼‰ã€‚

### 3.3 æ‰§è¡Œè·¯ç”±

`executeTool(name, args)` æ ¹æ®å·¥å…·ååˆ†å‘åˆ°å¯¹åº”çš„æœ¬åœ°å‡½æ•°ï¼š

- **`queryTimeEntries`**ï¼š
  1. è§£ææ—¥æœŸå‚æ•°ï¼Œåˆ›å»º `DateRange`
  2. å¦‚æœ‰ `category` / `goal` å‚æ•°ï¼Œé€šè¿‡åç§°æ¨¡ç³ŠåŒ¹é…åˆ° ID
  3. è°ƒç”¨ `loadRawData(filters)` ä» IndexedDB æŸ¥è¯¢
  4. è°ƒç”¨ `processEntries()` å…³è”ç±»åˆ«å/ç›®æ ‡å
  5. èšåˆç»Ÿè®¡ï¼ˆç±»åˆ«åˆ†å¸ƒã€ç›®æ ‡åˆ†å¸ƒ Top 10ï¼‰
  6. æ ¼å¼åŒ–ä¸ºç»“æ„åŒ–æ–‡æœ¬è¿”å›

- **`listCategories`**ï¼šç›´æ¥ä» `db.categories` è¯»å–

- **`listGoals`**ï¼šä» `db.goals` æŒ‰æ—¥æœŸèŒƒå›´è¿‡æ»¤

---

## 4. å·¥å…·è°ƒç”¨å¼•æ“ (`toolCallEngine.ts`)

### 4.1 å…¥å£å‡½æ•°

```typescript
runToolCallLoop(
  config: LLMConfig,
  userQuery: string,
  history: ChatMessage[],
  callbacks: ToolCallEngineCallbacks,
  signal?: AbortSignal,
): Promise<{ content: string; thinking?: string }>
```

### 4.2 æ‰§è¡Œæµç¨‹

1. **æ„å»º System Prompt**ï¼šè§’è‰²å®šä¹‰ + å½“å‰æ—¥æœŸ + ç±»åˆ«åˆ—è¡¨ + å·¥å…·ä½¿ç”¨æŒ‡å— + å›ç­”è§„åˆ™
2. **å‘èµ·éæµå¼è¯·æ±‚**ï¼ˆå¸¦ `tools` å‚æ•°ï¼‰
3. **æ£€æŸ¥å“åº”**ï¼š
   - æœ‰ `tool_calls` â†’ æœ¬åœ°æ‰§è¡Œå·¥å…· â†’ ç»“æœä»¥ `role: 'tool'` å›å¡«æ¶ˆæ¯åˆ—è¡¨ â†’ å›åˆ°æ­¥éª¤ 2
   - æ—  `tool_calls` â†’ LLM ç›´æ¥è¿”å›äº†æ–‡æœ¬å›ç­”
4. **å¾ªç¯ä¸Šé™**ï¼šæœ€å¤š 5 è½®å·¥å…·è°ƒç”¨ï¼Œé˜²æ­¢æ— é™å¾ªç¯
5. **æœ€ç»ˆè¾“å‡º**ï¼šæµå¼è°ƒç”¨ `chatStream` è¾“å‡ºæœ€ç»ˆå›ç­”

### 4.3 å›è°ƒæ¥å£

| å›è°ƒ | ç”¨é€” |
|------|------|
| `onPhase(phase, detail)` | é˜¶æ®µæ›´æ–°ï¼ˆpreparing / thinking / toolCall / answeringï¼‰ |
| `onChunk(delta)` | æµå¼æ–‡æœ¬å¢é‡ |
| `onThinking(delta)` | æ¨ç†è¿‡ç¨‹å¢é‡ï¼ˆDeepSeek-R1 / QwQ ç­‰ thinking æ¨¡å‹ï¼‰ |
| `onToolCall(info)` | å·¥å…·è¢«è°ƒç”¨çš„é€šçŸ¥ |

### 4.4 Fallback æœºåˆ¶

å¦‚æœ LLM ä¸æ”¯æŒ Function Callingï¼ˆè¿”å›é”™è¯¯æˆ–ç›´æ¥å›ç­”ï¼‰ï¼Œå¼•æ“ä¼šè·³è¿‡å·¥å…·è°ƒç”¨å¾ªç¯ï¼Œç›´æ¥ä½¿ç”¨æµå¼è¯·æ±‚è®© LLM åŸºäº system prompt ä¸­çš„ä¿¡æ¯å›ç­”ã€‚

---

## 5. LLM ç½‘ç»œå±‚ (`llmClient.ts`)

æ‰€æœ‰ LLM API è°ƒç”¨éµå¾ª **OpenAI å…¼å®¹åè®®**ï¼ˆ`/chat/completions`ï¼‰ï¼Œé›¶å¤–éƒ¨ä¾èµ–ï¼Œä½¿ç”¨åŸç”Ÿ `fetch` + `ReadableStream`ã€‚

### 5.1 ä¸‰ä¸ªè°ƒç”¨å‡½æ•°

| å‡½æ•° | æ¨¡å¼ | ç”¨é€” |
|------|------|------|
| `chatStream(config, messages, onChunk, signal, onThinking)` | æµå¼ SSE | æœ€ç»ˆå›ç­”çš„æ‰“å­—æœºè¾“å‡º |
| `chatOnce(config, messages, signal)` | éæµå¼ | [é—ç•™] è½»é‡å•æ¬¡è°ƒç”¨ |
| `chatWithTools(config, messages, tools, signal)` | éæµå¼ + tools | å·¥å…·è°ƒç”¨è¯·æ±‚ï¼Œè¿”å›å« `tool_calls` çš„å®Œæ•´ message |

### 5.2 æµå¼è§£æ

- è§£æ SSEï¼ˆServer-Sent Eventsï¼‰`data:` è¡Œ
- æå– `delta.content`ï¼ˆæ­£æ–‡ï¼‰å’Œ `delta.reasoning_content` / `delta.thinking_content`ï¼ˆæ¨ç†è¿‡ç¨‹ï¼‰
- æ”¯æŒ `[DONE]` ä¿¡å·å’Œç•¸å½¢ JSON å®¹é”™

### 5.3 è¯·æ±‚å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `temperature` | 0.7 | ç”Ÿæˆå¤šæ ·æ€§ |
| `max_tokens` | 2048 | å•æ¬¡æœ€å¤§è¾“å‡º |
| `stream` | true/false | æ ¹æ®è°ƒç”¨å‡½æ•°å†³å®š |

---

## 6. æœåŠ¡å•†é…ç½® (`providers.ts`)

å†…ç½®ä»¥ä¸‹ OpenAI å…¼å®¹æœåŠ¡å•†é¢„è®¾ï¼š

| æœåŠ¡å•† | ID | Base URL | é»˜è®¤æ¨¡å‹ |
|--------|-----|----------|----------|
| é€šä¹‰åƒé—® | `qwen` | `dashscope.aliyuncs.com/compatible-mode/v1` | qwen3.5-plus |
| Gemini | `gemini` | `generativelanguage.googleapis.com/v1beta/openai` | gemini-3-flash-preview |
| æ™ºè°± GLM | `glm` | `open.bigmodel.cn/api/paas/v4` | glm-4-flash |
| Kimi | `kimi` | `api.moonshot.cn/v1` | moonshot-v1-auto |
| MiniMax | `minimax` | `api.minimax.chat/v1` | MiniMax-Text-01 |
| OpenAI | `openai` | `api.openai.com/v1` | gpt-4.1-mini |
| è‡ªå®šä¹‰ | `custom` | ç”¨æˆ·å¡«å†™ | ç”¨æˆ·å¡«å†™ |

**æ¯ä¸ª Provider çš„é…ç½®ç‹¬ç«‹ä¿å­˜**ï¼ˆ`localStorage`ï¼‰ï¼Œåˆ‡æ¢æœåŠ¡å•†æ—¶è‡ªåŠ¨æ¢å¤å¯¹åº”çš„ API Key å’Œæ¨¡å‹é€‰æ‹©ï¼Œæ— éœ€é‡æ–°å¡«å†™ã€‚

---

## 7. çŠ¶æ€ç®¡ç† (`aiStore.ts`)

ä½¿ç”¨ Zustand ç®¡ç†ä¸¤éƒ¨åˆ†çŠ¶æ€ï¼š

### 7.1 é…ç½®çŠ¶æ€

```typescript
interface AIConfig {
  providerId: string;  // å½“å‰æœåŠ¡å•† ID
  baseURL: string;     // API ç«¯ç‚¹
  apiKey: string;      // API å¯†é’¥
  model: string;       // æ¨¡å‹åç§°
}
```

- æŒä¹…åŒ–åˆ° `localStorage`ï¼ˆkey: `ai-config`ï¼‰
- æ”¯æŒä»æ—§ç‰ˆå•é…ç½®æ ¼å¼è‡ªåŠ¨è¿ç§»

### 7.2 å¯¹è¯çŠ¶æ€

```typescript
interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  loading?: boolean;       // æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
  error?: boolean;         // æ˜¯å¦å‡ºé”™
  phases?: Phase[];        // æ‰§è¡Œé˜¶æ®µåˆ—è¡¨
  thinking?: string;       // æ¨ç†è¿‡ç¨‹
}
```

- `phases` æ•°ç»„è®°å½•æ¯æ¬¡å¯¹è¯çš„æ‰§è¡Œé˜¶æ®µï¼ˆå‡†å¤‡ã€åˆ†æã€å·¥å…·è°ƒç”¨ã€ç”Ÿæˆï¼‰ï¼Œåœ¨ UI ä¸Šä»¥æ­¥éª¤åˆ—è¡¨å±•ç¤º
- `thinking` è®°å½• thinking æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼Œåœ¨ UI ä¸Šä»¥å¯æŠ˜å é¢æ¿å±•ç¤º

---

## 8. UI ç»„ä»¶

### 8.1 AIAssistant.tsxï¼ˆä¸»é¢æ¿ï¼‰

- **æ¬¢è¿ç•Œé¢**ï¼šæ— æ¶ˆæ¯æ—¶æ˜¾ç¤ºå¿«æ· Prompt æŒ‰é’®ï¼ˆ7 ä¸ªé¢„è®¾é—®é¢˜ï¼‰
- **å¯¹è¯åŒº**ï¼šæ¶ˆæ¯æ°”æ³¡åˆ—è¡¨ï¼Œæ”¯æŒ Markdown æ¸²æŸ“ï¼ˆåŠ ç²—ã€åˆ—è¡¨ã€æ ‡é¢˜ã€ä»£ç ï¼‰
- **é˜¶æ®µæŒ‡ç¤ºå™¨**ï¼ˆ`PhasesIndicator`ï¼‰ï¼šæ˜¾ç¤ºå½“å‰è¯·æ±‚çš„å¤„ç†é˜¶æ®µ
  - ğŸ“‹ å‡†å¤‡ä¸Šä¸‹æ–‡
  - ğŸ’­ åˆ†æé—®é¢˜
  - ğŸ”§ æŸ¥è¯¢æ•°æ®ï¼ˆæ˜¾ç¤ºå…·ä½“çš„æŸ¥è¯¢å‚æ•°ï¼‰
  - âœï¸ ç”Ÿæˆå›ç­”
- **è¾“å…¥åŒº**ï¼šè‡ªé€‚åº”é«˜åº¦çš„ textarea + å‘é€/åœæ­¢æŒ‰é’®
- **æµå¼è¾“å‡º**ï¼šæ‰“å­—æœºæ•ˆæœ + é—ªçƒå…‰æ ‡

### 8.2 AISettings.tsxï¼ˆè®¾ç½®å¼¹çª—ï¼‰

- æœåŠ¡å•†ä¸‹æ‹‰é€‰æ‹©ï¼ˆå·²é…ç½®çš„æ ‡è®° âœ“ï¼‰
- API Key è¾“å…¥ï¼ˆpassword ç±»å‹ï¼Œä»…å­˜æœ¬åœ°ï¼‰
- æ¨¡å‹é€‰æ‹©ï¼ˆé¢„è®¾åˆ—è¡¨æˆ–è‡ªå®šä¹‰è¾“å…¥ï¼‰
- é«˜çº§è®¾ç½®ï¼šBase URL ä¿®æ”¹ï¼ˆæ”¯æŒ Ollama æœ¬åœ°æ¨¡å‹ç­‰è‡ªå®šä¹‰ç«¯ç‚¹ï¼‰

---

## 9. å®‰å…¨ä¸éšç§

- **API Key ä»…å­˜å‚¨åœ¨æµè§ˆå™¨ localStorage**ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•ç¬¬ä¸‰æ–¹æœåŠ¡å™¨
- **æ—¶é—´è®°å½•æ•°æ®ä¸ç¦»å¼€æœ¬åœ°**ï¼Œå·¥å…·å‡½æ•°åœ¨æµè§ˆå™¨å†…æ‰§è¡Œï¼Œä»…å°†æ ¼å¼åŒ–åçš„æ–‡æœ¬æ‘˜è¦å‘é€ç»™ LLM
- **LLM API è°ƒç”¨ç›´æ¥ä»æµè§ˆå™¨å‘å¾€ç”¨æˆ·é€‰æ‹©çš„æœåŠ¡å•†**ï¼Œæ— ä¸­é—´ä»£ç†
- ç”¨æˆ·å¯éšæ—¶åœ¨è®¾ç½®ä¸­æ¸…é™¤ API Key
